┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃           🧪 Iron-MD 텔레옵 노트북 테스트 빠른 시작             ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

📋 목적
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
노트북의 can0에 Iron-MD 조종기만 연결하여 텔레옵 노드가
조종기 입력을 제대로 받고 ROS2 토픽을 발행하는지 확인합니다.

⚠️  실제 모터는 없으므로 터미널 출력으로만 확인합니다.


🔧 1단계: CAN 인터페이스 설정
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

터미널 1:
  $ cd ~/ros2_ws_backup
  $ ./setup_can_test.sh

  또는 수동:
  $ sudo ip link set can0 type can bitrate 250000
  $ sudo ip link set can0 up


🔌 2단계: Iron-MD 조종기 연결 확인
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

터미널 1:
  $ candump can0

  1. Iron-MD 조종기 전원 ON
  2. 다음 메시지들이 보여야 함:

     can0  1E4   [4]  7F 7F 7F 7F        (조이스틱, 50ms)
     can0  2E4   [8]  00 00 00 00 00 00 40 00  (스위치, 50ms)
     can0  764   [8]  00 00 00 00 00 00 00 00  (Heartbeat, 300ms)

  ✅ 위 메시지들이 보이면 Ctrl+C로 종료하고 다음 단계


🚀 3단계: 텔레옵 노드 실행
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

터미널 1:
  $ cd ~/ros2_ws_backup
  $ ./start_test.sh

  또는 수동:
  $ source install/setup.bash
  $ ros2 launch rebar_control test_teleop.launch.py


📊 4단계: 디버그 출력 확인
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1초마다 다음 화면이 자동으로 출력됩니다:

┌─────────────────────────────────────────────────────────────────────┐
│                  🎮 Iron-MD 조종기 상태 (DEBUG)                    │
├─────────────────────────────────────────────────────────────────────┤
│ 연결 상태: ✅ 송신기 연결됨
│ 제어 모드: 🎮 Remote Control
│ 비상정지: ✅ 정상
│
│ [조이스틱 값 - Raw / 정규화]
│   AN1 (X축):   127 → +0.00
│   AN2 (Y축):   127 → +0.00
│   AN3 (주행):  127 → +0.00
│   AN4 (예비):  127 → +0.00
│
│ [현재 위치]
│   하부체 횡이동: +0.000 m
│   상부체 X축:   +0.000 m
│   상부체 Y축:   +0.000 m
│   상부체 Z축:   +0.000 m
│   공구 Yaw:    +0.0°
│
│ [스위치 상태]
│   모드: S19=ON S20=off
│   횡이동: S17=off S18=off
│   작업: S21=off S22=off
│   Yaw: S23=off S24=off
│   트리거: S00=off S01=off
└─────────────────────────────────────────────────────────────────────┘


🎯 5단계: 조종기 테스트
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

아래 동작들을 하나씩 테스트하고 터미널 출력을 확인하세요:

┌─────────────────────────────────────────────────────────────────────┐
│ 조이스틱 (연속 제어)                                                │
├─────────────────────────────────────────────────────────────────────┤
│ AN3 앞으로   → 🚗 주행 → /cmd_vel: linear=-0.XX m/s                │
│ AN3 뒤로     → 🚗 주행 → /cmd_vel: linear=+0.XX m/s                │
│ AN1 좌측     → 📐 X축 → /joint_2/position: +0.XXXX m              │
│ AN1 우측     → 📐 X축 → /joint_2/position: -0.XXXX m              │
│ AN2 앞으로   → 📐 Y축 → /joint_3/position: +0.XXXX m              │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ 스위치 (엣지 트리거 - 올리거나 내린 후 중립으로!)                  │
├─────────────────────────────────────────────────────────────────────┤
│ S17 올림     → ➡️  횡이동 +50mm (위치: 0.050m)                     │
│ S18 내림     → ⬅️  횡이동 -50mm (위치: 0.000m)                     │
│                                                                     │
│ S21 올림     → 🔽 작업 시퀀스: Z축 하강 → 그리퍼 닫기               │
│ S22 내림     → 🔧 작업 시퀀스: 트리거 → 그리퍼 열기 → Z축 상승      │
│                                                                     │
│ S23 올림     → ↻  Yaw +30° (위치: 30.0°)                           │
│ S24 내림     → ↺  Yaw -30° (위치: 0.0°)                            │
│                                                                     │
│ S19 올림     → 🎮 Remote Control 모드                               │
│ S20 내림     → 🤖 Automatic Control 모드                            │
└─────────────────────────────────────────────────────────────────────┘


📡 6단계: ROS2 토픽 모니터링 (선택)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

터미널 2를 새로 열어서:

  $ source ~/ros2_ws_backup/install/setup.bash

  # 주행 명령
  $ ros2 topic echo /cmd_vel

  # X축 위치
  $ ros2 topic echo /joint_2/position

  # 그리퍼
  $ ros2 topic echo /gripper/position

  # 모든 토픽 리스트
  $ ros2 topic list


🛠️  문제 해결
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌─────────────────────────────────────────────────────────────────────┐
│ 문제                    │ 해결 방법                                  │
├─────────────────────────┼───────────────────────────────────────────┤
│ CAN 메시지 안 들어옴    │ - can0 UP 확인: ip link show can0         │
│                         │ - 비트레이트 확인: 250000                  │
│                         │ - 조종기 전원 확인                         │
│                         │                                            │
│ 송신기 연결 안됨        │ - 디버그 출력: 연결 상태 확인              │
│ (TX_Connected=0)        │ - candump로 0x2E4 Byte6 확인               │
│                         │ - 조종기/수신기 페어링                     │
│                         │                                            │
│ 조이스틱 반응 없음      │ - 조이스틱 실제로 움직이기                 │
│                         │ - 데드존 확인 (127±20)                     │
│                         │ - candump로 0x1E4 값 변경 확인             │
│                         │                                            │
│ 스위치가 계속 실행됨    │ - 스위치를 중립으로 복귀!                  │
│                         │ - candump로 스위치 비트 확인               │
│                         │                                            │
│ 디버그 출력 안 보임     │ - ros2 param get /iron_md_teleop debug_mode│
│                         │ - true로 설정해야 함                       │
└─────────────────────────┴───────────────────────────────────────────┘


✅ 테스트 완료 후
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

모든 기능이 정상 동작하는 것을 확인했다면:

  1. Ctrl+C로 텔레옵 노드 종료
  2. TEST_GUIDE.md의 체크리스트 작성
  3. 실제 장비 배포 준비:
     - config/params.yaml: can_interface를 'can2'로 변경
     - debug_mode를 false로 변경


📚 상세 정보
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  - 전체 테스트 가이드: TEST_GUIDE.md
  - 조이스틱 매핑 변경 이력: src/rebar_control/docs/JOYSTICK_MAPPING_UPDATE.md
  - Iron-MD CAN 사양: src/rebar_control/docs/IRON_MD_GUIDE.md


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎉 즐거운 테스트 되세요!
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
